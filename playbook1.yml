---
- hosts: otherservers
  become: yes
  tasks:
    - name: update apt cache
      apt: update_cache=yes
    - name: remove apache
      apt: name=apache2 state=absent
    - name: install jdk
      apt: name=openjdk-8-jdk-headless state=present

- hosts: host2
  become: yes
  tasks:
    - name: install postgresql
      apt: name=postgresql update_cache=true state=present
    - name: Ensure the PostgreSQL service is running
      service: name=postgresql state=started enabled=yes

#    - name: Ensure database is created
#      sudo_user: postgres
#      postgresql_db: name={{ db_name }}
#       encoding='UTF-8'
#       lc_collate='en_US.UTF-8'
#       lc_ctype='en_US.UTF-8'
#       template='template0'
#       state=present
#
#    - name: Ensure user has access to the database
#      sudo_user: postgres
#      postgresql_user: db={{ db_name }}
#       name={{ db_user }}
#       password={{ db_password }}
#       priv=ALL
#      state=present
#
#    - name: Ensure user does not have unnecessary privileges
#      sudo_user: postgres
#      postgresql_user: name={{ db_user }}
#       role_attr_flags=NOSUPERUSER,NOCREATEDB
#       state=pr
- hosts: host1
  become: yes
  tasks:
    - name: install tomcat8
      apt: name=tomcat8 state=present
    - name: install tomcat8admin
      apt: name=tomcat8-admin state=present
    - name: install git
      apt: name=git state=present 
    - name: install nodejs
      shell: apt-get install nodejs -y
    - name: install nodejs
      shell: apt-get install npm -y
    - name: create symbolic link
      file:
        src: /usr/bin/nodejs
        dest: /usr/bin/node
        state: link
    - name: clone repository
      git:
        repo: https://1191780@bitbucket.org/martalribeiro/devops_g2_maven.git
        dest: /home/vagrant/devops_g2_maven
    - name: give permission to execute maven wrapper
      file:
        path: /home/vagrant/devops_g2_maven/personalFinanceManagement/mvnw
        mode: "+rwx"
    - name: maven build
      shell:
        cmd: ./mvnw package -Dmaven.test.skip=true
        chdir: /home/vagrant/devops_g2_maven/personalFinanceManagement
    - name: give permission to execute jar file
      file:
        path: /home/vagrant/devops_g2_maven/personalFinanceManagement/target/devOpsProject-1.0-SNAPSHOT.jar
        mode: "+rwx"
    - name: deploy the war file to tomcat8
      shell:
       cmd: cp K /var/lib/tomcat8/webapps
       chdir: /home/vagrant/devops_g2_maven/personalFinanceManagement/target

