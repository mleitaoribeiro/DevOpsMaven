pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out...'
                git url: 'https://martalribeiro@bitbucket.org/martalribeiro/devops_g2_maven.git/'
            }
        }
        stage('Assemble') {
            steps {
                dir('personalFinanceManagement') {
                    echo 'Building...'
                    sh 'chmod +x mvnw'
                    sh './mvnw package -Dmaven.test.skip=true '
                }
            }
        }
        stage ('Javadoc'){
            steps {
                dir('personalFinanceManagement') {
                    echo 'Generating javadocs...'
                    sh 'chmod +x mvnw'
                    sh './mvnw javadoc:javadoc'
                    publishHTML ([
                                reportName: 'Javadoc',
                                reportDir: 'target/site/apidocs/',
                                reportFiles: 'index.html',
                                keepAll: true,
                                alwaysLinkToLastBuild: false,
                                allowMissing: true
                    ])
                }
            }
        }
        stage('Archiving') {
            steps {
                dir('personalFinanceManagement') {
                    sh 'dir'
                    echo 'Archiving...'
                    archiveArtifacts 'target/*.war'
                }
            }
        }
        stage('Docker Image') {
             steps {
                dir ('scripts') {
                    script {
                        webAppImage = docker.build("gabriel1191765/devops_g2_maven:${env.BUILD_ID}")
                    }
                }
                dir ('scripts') {
                    script {
                        dbImage = docker.build("gabriel1191765/devops_g2_maven:${env.BUILD_ID}")
                    }
                }
            }
        }
        stage('Publish Image') {
            steps {
                script{
                    sh 'docker login -u="gabriel1191765" -p="gabriel2636"'
                    webAppImage.push()
                    dbImage.push()
                }
            }
        }

       stage('Ansible Deploy') {
            steps {
                dir('devops_g2_maven/scripts') {
                        ansiblePlaybook (
                           credentialsId: 'sample-ssh-key'',
                           become: true,
                           disableHostKeyChecking: true,
                           inventory: 'hosts',
                           playbook: 'playbook1.yml'
                   )
               }
            }
        }

        stage('Test') {
            steps {
                dir('personalFinanceManagement') {
                    echo 'Testing...'
                    sh 'chmod +x mvnw'
                    sh './mvnw surefire-report:report '
                    archiveArtifacts 'target/site/*.html'
                }
                dir('personalFinanceManagement') {
                    echo 'Generating code coverage...'
                    sh 'chmod +x mvnw'
                    sh './mvnw verify'
                    archiveArtifacts 'target/site/jacoco/index.html'
                }
            }
        }
    }
}